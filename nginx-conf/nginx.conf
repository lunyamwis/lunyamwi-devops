# server {
#         listen 80;
#         listen [::]:80;
#         server_name demo.lunyamwi.org;

#         location ~ /.well-known/acme-challenge {
#           allow all;
#           root /usr/share/nginx/html;
#         }

#         location / {
#                 rewrite ^ https://$host$request_uri? permanent;
#         }
# }

# server {
#         listen 80;
#         listen [::]:80;
#         listen 443 ssl http2;
#         listen [::]:443 ssl http2;
#         server_name demo.lunyamwi.org;

#         server_tokens off;

#         ssl_certificate /etc/letsencrypt/live/demo.lunyamwi.org/fullchain.pem;
#         ssl_certificate_key  /etc/letsencrypt/live/demo.lunyamwi.org/privkey.pem;

#         ssl_buffer_size 8k;

#         ssl_dhparam /etc/ssl/certs/dhparam-2048.pem;

#         ssl_protocols TLSv1.2;
#         ssl_prefer_server_ciphers on;

#         ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

#         ssl_ecdh_curve secp384r1;
#         ssl_session_tickets off;
#         ssl_stapling on;
#         ssl_stapling_verify on;
#         resolver 8.8.8.8;

#         location / {
#                 try_files $uri /index.html;
#         }

#        # location /prompt/ {
#        #         proxy_pass http://prompt:8001/;
#        #         proxy_set_header Host $http_host;
#        #         proxy_set_header X-Real-IP $remote_addr;
#        #         proxy_set_header X-Forwaded-For $proxy_add_x_forwarded_for;
#        #         proxy_set_header X-Forwaded-Proto $scheme;
#        #  }

#         location /api/ {
#                 proxy_pass http://api:8000/;
#                 proxy_set_header Host $http_host;
#                 proxy_set_header X-Real-IP $remote_addr;
#                 proxy_set_header X-Forwaded-For $proxy_add_x_forwarded_for;
#                 proxy_set_header X-Forwaded-Proto $scheme;
#          }

#         root /usr/share/nginx/html;
#         index index.html index.htm index.nginx-debian.html;
# }

# server {
#         listen 80;
#         listen [::]:80;
#         server_name api.lunyamwi.org;
#         location ~ /.well-known/acme-challenge {
#           allow all;
#           root /usr/share/nginx/html;
#         }
#         location / {
#                 rewrite ^ https://$host$request_uri? permanent;
#         }
#         #location / {
#         #       proxy_pass http://api:8000/;
#         #}
# }

# server {
#          listen 443 ssl http2;
#          listen [::]:443 ssl http2;
#          server_name api.lunyamwi.org;

#          server_tokens off;

#          ssl_certificate /etc/letsencrypt/live/api.lunyamwi.org/fullchain.pem;
#          ssl_certificate_key /etc/letsencrypt/live/api.lunyamwi.org/privkey.pem;

#          ssl_buffer_size 8k;
#          ssl_protocols TLSv1.2;
#          ssl_prefer_server_ciphers on;

#          ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

#          ssl_ecdh_curve secp384r1;
#          ssl_session_tickets off;

#          ssl_stapling on;
#          ssl_stapling_verify on;
#          resolver 8.8.8.8;

#          location / {
#                  proxy_pass      http://api:8000/;
#          }
# }

#server {
      #  listen 80;
     # listen [::]:80;
    #    server_name promptemplate.lunyamwi.org;

   #     location ~ /.well-known/acme-challenge {
 #         allow all;
  #        root /usr/share/nginx/html;
 #       }

#        location / {
#                rewrite ^ https://$host$request_uri? permanent;
#        }

#}

#server {
#        listen 443 ssl http2;
#        listen [::]:443 ssl http2;
#        server_name promptemplate.lunyamwi.org;
#
 #       server_tokens off;

        #ssl_certificate  /etc/letsencrypt/live/promptemplate.lunyamwi.org/fullchain.pem;
        #ssl_certificate_key  /etc/letsencrypt/live/promptemplate.lunyamwi.org/privkey.pem;

#        ssl_buffer_size 8k;
#
#        ssl_protocols TLSv1.2;
#        ssl_prefer_server_ciphers on;
#
#        ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;
#
#        ssl_ecdh_curve secp384r1;
#        ssl_session_tickets off;
#
#        ssl_stapling on;
#        ssl_stapling_verify on;
#        resolver 8.8.8.8;
#
#        location / {
#                proxy_pass      http://prompt:8001/;
#        }
#}

server {
        listen 80;
        listen [::]:80;
        server_name *.lunyamwi.org lunyamwi.org;

        location ^~ /.well-known/acme-challenge/ {
          root /usr/share/nginx/html;
          allow all;
        }

        location / {
                rewrite ^ https://$host$request_uri? permanent;
        }
}

server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
	server_name *.lunyamwi.org lunyamwi.org;
	ssl_certificate /etc/letsencrypt/live/lunyamwi.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/lunyamwi.org/privkey.pem;
        server_tokens off;
        ssl_buffer_size 8k;
        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;
        ssl_ecdh_curve secp384r1;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;
        resolver 8.8.8.8;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        fastcgi_read_timeout 300;
        keepalive_timeout 75;

	location / {
		proxy_pass http://web:8003;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  	  	proxy_set_header X-Forwarded-Proto $scheme;
  	}
}

server {
        listen 80;
        listen [::]:80;
        server_name airflow.lunyamwi.org;

        location ~ /.well-known/acme-challenge {
          allow all;
          root /usr/share/nginx/html;
        }

        location / {
                rewrite ^ https://$host$request_uri? permanent;
        }
}

 server {
         listen 443 ssl http2;
         listen [::]:443 ssl http2;
         server_name airflow.lunyamwi.org;

         server_tokens off;

         ssl_certificate /etc/letsencrypt/live/airflow.lunyamwi.org/fullchain.pem;
         ssl_certificate_key /etc/letsencrypt/live/airflow.lunyamwi.org/privkey.pem;

         ssl_buffer_size 8k;

         ssl_protocols TLSv1.2;
         ssl_prefer_server_ciphers on;

         ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

         ssl_ecdh_curve secp384r1;
         ssl_session_tickets off;

         ssl_stapling on;
         ssl_stapling_verify on;
         resolver 8.8.8.8;

         location / {
                proxy_pass http://airflow-api-server:8080/;

                # Forward important headers for Airflow to identify original request info
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
               
                proxy_redirect off;
        }

        # Optional: Add Content-Security-Policy header allowing iframe from same origin if needed
        add_header Content-Security-Policy "frame-ancestors 'self';";
 }


server {
        listen 80;
        listen [::]:80;
        server_name mqtt.lunyamwi.org;

        location ~ /.well-known/acme-challenge {
          allow all;
          root /usr/share/nginx/html;
        }

        location / {
                rewrite ^ https://$host$request_uri? permanent;
        }
}

server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name mqtt.lunyamwi.org; 

        server_tokens off;

        ssl_certificate /etc/letsencrypt/live/mqtt.lunyamwi.org/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/mqtt.lunyamwi.org/privkey.pem;

        ssl_buffer_size 8k;

        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;

        ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;

        ssl_ecdh_curve secp384r1;
        ssl_session_tickets off;

        ssl_stapling on;
        ssl_stapling_verify on;
        resolver 8.8.8.8;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        fastcgi_read_timeout 300;
        keepalive_timeout 75;


        location / {
                proxy_pass      http://mqtt:3000;
        }
}
